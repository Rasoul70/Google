<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ú†Øª Ø¯Ø§Ø®Ù„ÛŒ Ø§Ø¯Ø§Ø±Ù‡ - Ù†Ø³Ø®Ù‡ Ú©Ø§Ø±Ø¨Ø±Ø¯ÛŒ</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        @import url('https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Vazirmatn', sans-serif;
        }

        :root {
            --primary: #2e7d32;
            --secondary: #1565c0;
            --danger: #d32f2f;
            --bg: #f0f2f5;
        }

        body {
            background: var(--bg);
            min-height: 100vh;
        }

        .setup-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
        }

        .setup-box {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 500px;
            width: 100%;
            text-align: center;
        }

        .setup-box h1 {
            color: var(--primary);
            margin-bottom: 10px;
        }

        .setup-box p {
            color: #666;
            margin-bottom: 30px;
            line-height: 1.8;
        }

        .input-group {
            margin: 20px 0;
            text-align: right;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }

        .input-group input, .input-group select {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
        }

        .btn {
            width: 100%;
            padding: 15px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
            transition: all 0.3s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        }

        .btn-secondary {
            background: var(--secondary);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .chat-container {
            display: none;
            height: 100vh;
            flex-direction: column;
        }

        .chat-header {
            background: white;
            padding: 15px 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
        }

        .status-connecting {
            background: #fff3e0;
            color: #e65100;
        }

        .status-connected {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .main-content {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        .sidebar {
            width: 300px;
            background: white;
            border-left: 1px solid #ddd;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .info-box {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 10px;
            font-size: 14px;
        }

        .info-box strong {
            color: var(--secondary);
            display: block;
            margin-bottom: 5px;
        }

        .peer-id-box {
            background: #fff3e0;
            padding: 10px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
            word-break: break-all;
            cursor: pointer;
            border: 2px dashed #ff9800;
        }

        .connections-list {
            flex: 1;
        }

        .connection-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .connection-status-icon {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #4caf50;
        }

        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f0f2f5;
        }

        .message {
            max-width: 70%;
            margin-bottom: 15px;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.own {
            margin-left: auto;
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 5px;
            font-size: 12px;
            color: #666;
        }

        .message-content {
            background: white;
            padding: 12px 15px;
            border-radius: 15px;
            border-bottom-right-radius: 5px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            word-wrap: break-word;
            line-height: 1.6;
        }

        .message.own .message-content {
            background: #c8e6c9;
            border-bottom-right-radius: 15px;
            border-bottom-left-radius: 5px;
        }

        .message-file {
            background: white;
            padding: 15px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .file-icon {
            width: 50px;
            height: 50px;
            background: var(--secondary);
            color: white;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .file-info {
            flex: 1;
        }

        .file-name {
            font-weight: bold;
            margin-bottom: 5px;
            word-break: break-all;
        }

        .file-size {
            font-size: 12px;
            color: #666;
        }

        .input-area {
            background: white;
            padding: 20px;
            border-top: 1px solid #ddd;
        }

        .typing-indicator {
            font-size: 12px;
            color: #666;
            margin-bottom: 10px;
            height: 20px;
            font-style: italic;
        }

        .input-wrapper {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .message-input {
            flex: 1;
            padding: 12px 20px;
            border: 2px solid #ddd;
            border-radius: 25px;
            font-size: 15px;
        }

        .message-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .icon-btn {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .attach-btn {
            background: #f0f0f0;
            color: #666;
        }

        .send-btn {
            background: var(--primary);
            color: white;
        }

        .send-btn:disabled {
            background: #ccc;
        }

        .toast {
            position: fixed;
            top: 20px;
            left: 20px;
            background: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            transform: translateX(-400px);
            transition: transform 0.3s;
            z-index: 3000;
            max-width: 350px;
        }

        .toast.show {
            transform: translateX(0);
        }

        .connect-panel {
            margin-top: 20px;
            padding: 20px;
            background: #f5f5f5;
            border-radius: 10px;
        }

        .connect-panel input {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .hidden { display: none !important; }

        @media (max-width: 768px) {
            .sidebar { display: none; }
        }
    </style>
</head>
<body>

    <!-- ØµÙØ­Ù‡ ÙˆØ±ÙˆØ¯ -->
    <div class="setup-container" id="setupContainer">
        <div class="setup-box">
            <h1>ğŸ’¬ Ú†Øª Ø¯Ø§Ø®Ù„ÛŒ Ø§Ø¯Ø§Ø±Ù‡</h1>
            <p>Ø¨Ø¯ÙˆÙ† Ù†ÛŒØ§Ø² Ø¨Ù‡ Ù†ØµØ¨ Ø³Ø±ÙˆØ± - Ù…Ø³ØªÙ‚ÛŒÙ… Ø¨ÛŒÙ† Ú©Ø§Ù…Ù¾ÛŒÙˆØªØ±Ù‡Ø§</p>

            <div class="input-group">
                <label>Ù†Ø§Ù… Ø´Ù…Ø§:</label>
                <input type="text" id="usernameInput" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ø¹Ù„ÛŒ" maxlength="20">
            </div>

            <button class="btn" id="startBtn" onclick="startChat()">
                ğŸš€ Ø´Ø±ÙˆØ¹ Ú†Øª
            </button>

            <div id="connectSection" class="hidden" style="margin-top:20px;">
                <div class="info-box">
                    <strong>ğŸ†” Ø´Ù†Ø§Ø³Ù‡ Ø´Ù…Ø§ (Ø§ÛŒÙ† Ø±Ø§ Ú©Ù¾ÛŒ Ú©Ù†ÛŒØ¯):</strong>
                    <div class="peer-id-box" id="myPeerId" onclick="copyId()">
                        Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª...
                    </div>
                </div>

                <div class="connect-panel">
                    <label style="display:block;margin-bottom:5px;font-weight:bold;">Ø´Ù†Ø§Ø³Ù‡ Ù‡Ù…Ú©Ø§Ø± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:</label>
                    <input type="text" id="peerIdInput" placeholder="Ù…Ø«Ù„Ø§Ù‹: abc123...">
                    <button class="btn btn-secondary" onclick="connectToPeer()">
                        ğŸ”— Ø§ØªØµØ§Ù„
                    </button>
                </div>

                <div style="margin-top:15px;font-size:12px;color:#666;">
                    ğŸ’¡ Ø§ÛŒÙ† Ø´Ù†Ø§Ø³Ù‡ Ø±Ø§ Ø¨Ù‡ Ù‡Ù…Ú©Ø§Ø±Ø§Ù†ØªØ§Ù† Ø¨Ø¯Ù‡ÛŒØ¯ ØªØ§ Ø¨Ù‡ Ø´Ù…Ø§ ÙˆØµÙ„ Ø´ÙˆÙ†Ø¯
                </div>
            </div>
        </div>
    </div>

    <!-- ØµÙØ­Ù‡ Ú†Øª -->
    <div class="chat-container" id="chatContainer">
        <div class="chat-header">
            <div>
                <h2 style="color: var(--primary);">ğŸ’¬ Ú†Øª Ø¯Ø§Ø®Ù„ÛŒ</h2>
            </div>
            <div class="connection-status status-connecting" id="connectionStatus">
                <span class="status-dot"></span>
                <span>Ø¯Ø± Ø­Ø§Ù„ Ø§ØªØµØ§Ù„...</span>
            </div>
        </div>

        <div class="main-content">
            <div class="sidebar">
                <div class="info-box">
                    <strong>ğŸ‘¤ Ø´Ù…Ø§:</strong>
                    <span id="displayUsername">---</span>
                </div>

                <div class="info-box">
                    <strong>ğŸ†” Ø´Ù†Ø§Ø³Ù‡ Ø´Ù…Ø§:</strong>
                    <div class="peer-id-box" id="sidebarPeerId" style="margin-top:5px;" onclick="copyId()">
                        ---
                    </div>
                </div>

                <div class="connections-list">
                    <strong>ğŸ”— Ø§ØªØµØ§Ù„Ø§Øª:</strong>
                    <div id="connectionsList" style="margin-top:10px;">
                        <div style="color:#999;font-size:14px;">Ù‡Ù†ÙˆØ² Ú©Ø³ÛŒ ÙˆØµÙ„ Ù†Ø´Ø¯Ù‡</div>
                    </div>
                </div>

                <button class="btn" onclick="showConnectDialog()" style="margin-top:auto;">
                    â• Ø§ÙØ²ÙˆØ¯Ù† Ù‡Ù…Ú©Ø§Ø±
                </button>
            </div>

            <div class="chat-area">
                <div class="messages-container" id="messagesContainer">
                    <div style="text-align:center;padding:40px;color:#999;">
                        <div style="font-size:48px;margin-bottom:20px;">ğŸ‘‹</div>
                        <h3>Ø¨Ù‡ Ú†Øª Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯!</h3>
                        <p>Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ØŒ Ø´Ù†Ø§Ø³Ù‡ Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù‡ Ù‡Ù…Ú©Ø§Ø±Ø§Ù†ØªØ§Ù† Ø¨Ø¯Ù‡ÛŒØ¯</p>
                    </div>
                </div>
                
                <div class="input-area">
                    <div class="typing-indicator" id="typingIndicator"></div>
                    <div class="input-wrapper">
                        <button class="icon-btn attach-btn" onclick="document.getElementById('fileInput').click()" title="Ø§Ø±Ø³Ø§Ù„ ÙØ§ÛŒÙ„">
                            ğŸ“
                        </button>
                        <input type="file" id="fileInput" style="display:none" onchange="sendFile(this.files[0])">
                        <input type="text" class="message-input" id="messageInput" 
                               placeholder="Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯ Ùˆ Enter Ø¨Ø²Ù†ÛŒØ¯..." 
                               onkeypress="handleKeyPress(event)"
                               disabled>
                        <button class="icon-btn send-btn" id="sendBtn" onclick="sendMessage()" disabled>
                            â¤
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ø¯ÛŒØ§Ù„ÙˆÚ¯ Ø§ØªØµØ§Ù„ -->
    <div id="connectDialog" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:2000;justify-content:center;align-items:center;">
        <div style="background:white;padding:30px;border-radius:20px;max-width:400px;width:90%;">
            <h3 style="margin-bottom:20px;">ğŸ”— Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ù‡Ù…Ú©Ø§Ø±</h3>
            <input type="text" id="dialogPeerId" placeholder="Ø´Ù†Ø§Ø³Ù‡ Ù‡Ù…Ú©Ø§Ø±" style="width:100%;padding:15px;border:2px solid #ddd;border-radius:10px;margin-bottom:15px;">
            <div style="display:flex;gap:10px;">
                <button class="btn" onclick="connectFromDialog()" style="flex:1;">Ø§ØªØµØ§Ù„</button>
                <button class="btn" onclick="hideConnectDialog()" style="flex:1;background:#666;">Ø§Ù†ØµØ±Ø§Ù</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <script>
        let peer;
        let myId;
        let username;
        let connections = new Map(); // peerId -> {conn, username}
        let messageHistory = [];

        function startChat() {
            username = document.getElementById('usernameInput').value.trim() || 'Ú©Ø§Ø±Ø¨Ø± Ù†Ø§Ø´Ù†Ø§Ø³';
            
            document.getElementById('startBtn').disabled = true;
            document.getElementById('startBtn').textContent = 'â³ Ø¯Ø± Ø­Ø§Ù„ Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±...';

            // Ø³Ø§Ø®Øª Peer Ø¨Ø§ Ø³Ø±ÙˆØ± Ø±Ø§ÛŒÚ¯Ø§Ù† PeerJS
            peer = new Peer({
                host: 'peerjs-server.herokuapp.com',
                secure: true,
                port: 443,
                debug: 2
            });

            peer.on('open', (id) => {
                myId = id;
                document.getElementById('myPeerId').textContent = id;
                document.getElementById('sidebarPeerId').textContent = id;
                document.getElementById('displayUsername').textContent = username;
                document.getElementById('connectSection').classList.remove('hidden');
                document.getElementById('startBtn').textContent = 'âœ… Ø¢Ù…Ø§Ø¯Ù‡';
                showToast('âœ… Ø¢Ù…Ø§Ø¯Ù‡ Ø´Ø¯! Ø´Ù†Ø§Ø³Ù‡ Ø´Ù…Ø§: ' + id.substring(0, 8) + '...');
            });

            peer.on('error', (err) => {
                console.error(err);
                showToast('âŒ Ø®Ø·Ø§: ' + err.message);
                document.getElementById('startBtn').disabled = false;
                document.getElementById('startBtn').textContent = 'ğŸš€ ØªÙ„Ø§Ø´ Ù…Ø¬Ø¯Ø¯';
            });

            // Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø§ØªØµØ§Ù„
            peer.on('connection', (conn) => {
                handleConnection(conn);
            });
        }

        function handleConnection(conn) {
            conn.on('open', () => {
                console.log('Connection opened with:', conn.peer);
                
                // Ø§Ø±Ø³Ø§Ù„ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø®ÙˆØ¯
                conn.send({
                    type: 'intro',
                    username: username,
                    peerId: myId
                });

                connections.set(conn.peer, {
                    conn: conn,
                    username: 'Ø¯Ø± Ø­Ø§Ù„ Ø§ØªØµØ§Ù„...',
                    connected: true
                });

                updateConnectionsList();
                updateConnectionStatus();
                enableChat();
            });

            conn.on('data', (data) => {
                handleData(conn.peer, data);
            });

            conn.on('close', () => {
                console.log('Connection closed:', conn.peer);
                const connInfo = connections.get(conn.peer);
                showToast('ğŸ‘‹ ' + (connInfo?.username || 'Ù‡Ù…Ú©Ø§Ø±') + ' Ù‚Ø·Ø¹ Ø´Ø¯');
                connections.delete(conn.peer);
                updateConnectionsList();
                if (connections.size === 0) {
                    updateConnectionStatus(false);
                }
            });

            conn.on('error', (err) => {
                console.error('Connection error:', err);
                showToast('âŒ Ø®Ø·Ø§ÛŒ Ø§ØªØµØ§Ù„');
            });
        }

        function connectToPeer() {
            const peerId = document.getElementById('peerIdInput').value.trim();
            if (!peerId) {
                showToast('âŒ Ø´Ù†Ø§Ø³Ù‡ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
                return;
            }

            if (peerId === myId) {
                showToast('âŒ Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø¨Ù‡ Ø®ÙˆØ¯ØªØ§Ù† ÙˆØµÙ„ Ø´ÙˆÛŒØ¯!');
                return;
            }

            if (connections.has(peerId)) {
                showToast('âš ï¸ Ù‚Ø¨Ù„Ø§Ù‹ ÙˆØµÙ„ Ù‡Ø³ØªÛŒØ¯');
                return;
            }

            showToast('â³ Ø¯Ø± Ø­Ø§Ù„ Ø§ØªØµØ§Ù„...');
            const conn = peer.connect(peerId, {
                reliable: true
            });

            handleConnection(conn);
        }

        function handleData(fromPeerId, data) {
            switch(data.type) {
                case 'intro':
                    // Ù…Ø¹Ø±ÙÛŒ Ú©Ø§Ø±Ø¨Ø±
                    const connInfo = connections.get(fromPeerId);
                    if (connInfo) {
                        connInfo.username = data.username;
                        updateConnectionsList();
                        showToast('âœ… ' + data.username + ' ÙˆØµÙ„ Ø´Ø¯!');
                        
                        // Ø­Ø°Ù Ù¾ÛŒØ§Ù… Ø®ÙˆØ´â€ŒØ¢Ù…Ø¯Ú¯ÙˆÛŒÛŒ
                        const container = document.getElementById('messagesContainer');
                        if (container.children.length === 1) {
                            container.innerHTML = '';
                        }
                    }
                    break;

                case 'chat':
                    displayMessage({
                        ...data,
                        isOwn: false
                    });
                    break;

                case 'file-offer':
                    handleFileOffer(fromPeerId, data);
                    break;

                case 'file-chunk':
                    handleFileChunk(data);
                    break;
            }
        }

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            
            if (!text || connections.size === 0) return;

            const message = {
                type: 'chat',
                id: Date.now(),
                username: username,
                text: text,
                timestamp: new Date().toISOString()
            };

            // Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Ù‡Ù…Ù‡
            let sent = false;
            connections.forEach((connInfo, peerId) => {
                if (connInfo.conn.open) {
                    connInfo.conn.send(message);
                    sent = true;
                }
            });

            if (sent) {
                displayMessage({...message, isOwn: true});
                input.value = '';
            }
        }

        function displayMessage(data) {
            const container = document.getElementById('messagesContainer');
            
            // Ø­Ø°Ù Ù¾ÛŒØ§Ù… Ø§ÙˆÙ„ÛŒÙ‡
            if (container.children.length === 1 && container.querySelector('h3')) {
                container.innerHTML = '';
            }

            const div = document.createElement('div');
            div.className = `message ${data.isOwn ? 'own' : ''}`;
            
            const time = new Date(data.timestamp).toLocaleTimeString('fa-IR', {
                hour: '2-digit',
                minute: '2-digit'
            });

            div.innerHTML = `
                <div class="message-header">
                    <span style="font-weight:bold;">${data.isOwn ? 'Ø´Ù…Ø§' : data.username}</span>
                    <span style="color:#999;">${time}</span>
                </div>
                <div class="message-content">${escapeHtml(data.text)}</div>
            `;

            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        // ==================== File Transfer ====================

        let receivingFiles = new Map();

        async function sendFile(file) {
            if (!file || connections.size === 0) {
                showToast('âŒ Ø§Ø¨ØªØ¯Ø§ Ø¨Ù‡ Ú©Ø³ÛŒ ÙˆØµÙ„ Ø´ÙˆÛŒØ¯');
                return;
            }

            const fileId = Date.now().toString();
            const chunkSize = 16384; // 16KB
            
            showToast('ğŸ“¤ Ø¯Ø± Ø­Ø§Ù„ Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ ÙØ§ÛŒÙ„...');

            const buffer = await file.arrayBuffer();
            const totalChunks = Math.ceil(buffer.byteLength / chunkSize);

            // Ø§Ø±Ø³Ø§Ù„ Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙØ§ÛŒÙ„
            connections.forEach((connInfo) => {
                if (connInfo.conn.open) {
                    connInfo.conn.send({
                        type: 'file-offer',
                        fileId: fileId,
                        fileName: file.name,
                        fileSize: file.size,
                        totalChunks: totalChunks
                    });
                }
            });

            // Ø§Ø±Ø³Ø§Ù„ chunk Ù‡Ø§
            for (let i = 0; i < totalChunks; i++) {
                const chunk = buffer.slice(i * chunkSize, (i + 1) * chunkSize);
                const base64 = arrayBufferToBase64(chunk);

                connections.forEach((connInfo) => {
                    if (connInfo.conn.open) {
                        connInfo.conn.send({
                            type: 'file-chunk',
                            fileId: fileId,
                            chunk: base64,
                            index: i
                        });
                    }
                });

                if (i % 10 === 0) {
                    const progress = Math.round((i / totalChunks) * 100);
                    document.getElementById('typingIndicator').textContent = 
                        `ğŸ“¤ Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„: ${progress}%`;
                }
            }

            document.getElementById('typingIndicator').textContent = '';
            showToast('âœ… ÙØ§ÛŒÙ„ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯');
            
            // Ù†Ù…Ø§ÛŒØ´ Ø¯Ø± Ú†Øª
            displayMessage({
                type: 'chat',
                id: Date.now(),
                username: username,
                text: `ğŸ“ ÙØ§ÛŒÙ„ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯: ${file.name} (${formatFileSize(file.size)})`,
                timestamp: new Date().toISOString(),
                isOwn: true
            });
        }

        function handleFileOffer(fromPeerId, data) {
            receivingFiles.set(data.fileId, {
                chunks: [],
                fileName: data.fileName,
                fileSize: data.fileSize,
                received: 0,
                total: data.totalChunks
            });
            
            showToast('ğŸ“¥ Ø¯Ø±ÛŒØ§ÙØª ÙØ§ÛŒÙ„: ' + data.fileName);
        }

        function handleFileChunk(data) {
            const file = receivingFiles.get(data.fileId);
            if (!file) return;

            file.chunks[data.index] = base64ToArrayBuffer(data.chunk);
            file.received++;

            if (file.received === file.total) {
                // ØªÚ©Ù…ÛŒÙ„ ÙØ§ÛŒÙ„
                const blob = new Blob(file.chunks);
                const url = URL.createObjectURL(blob);
                
                // Ù†Ù…Ø§ÛŒØ´ Ø¯Ø± Ú†Øª
                displayMessage({
                    type: 'chat',
                    id: Date.now(),
                    username: connections.get(data.fileId)?.username || 'Ù‡Ù…Ú©Ø§Ø±',
                    text: `ğŸ“ ÙØ§ÛŒÙ„ Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯: ${file.fileName}`,
                    timestamp: new Date().toISOString(),
                    isOwn: false
                });

                // Ø§ÛŒØ¬Ø§Ø¯ Ù„ÛŒÙ†Ú© Ø¯Ø§Ù†Ù„ÙˆØ¯
                const a = document.createElement('a');
                a.href = url;
                a.download = file.fileName;
                a.style.display = 'block';
                a.style.marginTop = '5px';
                a.style.color = 'var(--secondary)';
                a.textContent = 'â¬‡ï¸ Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙØ§ÛŒÙ„';
                
                const lastMessage = document.getElementById('messagesContainer').lastChild;
                if (lastMessage) {
                    lastMessage.querySelector('.message-content').appendChild(a);
                }

                showToast('âœ… ÙØ§ÛŒÙ„ Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯: ' + file.fileName);
                receivingFiles.delete(data.fileId);
            }
        }

        // ==================== Utilities ====================

        function arrayBufferToBase64(buffer) {
            const bytes = new Uint8Array(buffer);
            let binary = '';
            for (let i = 0; i < bytes.byteLength; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            return btoa(binary);
        }

        function base64ToArrayBuffer(base64) {
            const binary = atob(base64);
            const bytes = new Uint8Array(binary.length);
            for (let i = 0; i < binary.length; i++) {
                bytes[i] = binary.charCodeAt(i);
            }
            return bytes.buffer;
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function handleKeyPress(e) {
            if (e.key === 'Enter') sendMessage();
        }

        function copyId() {
            navigator.clipboard.writeText(myId).then(() => {
                showToast('âœ… Ø´Ù†Ø§Ø³Ù‡ Ú©Ù¾ÛŒ Ø´Ø¯!');
            });
        }

        function updateConnectionsList() {
            const list = document.getElementById('connectionsList');
            
            if (connections.size === 0) {
                list.innerHTML = '<div style="color:#999;font-size:14px;">Ù‡Ù†ÙˆØ² Ú©Ø³ÛŒ ÙˆØµÙ„ Ù†Ø´Ø¯Ù‡</div>';
                return;
            }

            list.innerHTML = Array.from(connections.entries()).map(([peerId, info]) => `
                <div class="connection-item">
                    <div class="connection-status-icon"></div>
                    <div>
                        <div style="font-weight:bold;">${info.username}</div>
                        <div style="font-size:11px;color:#666;">${peerId.substring(0, 15)}...</div>
                    </div>
                </div>
            `).join('');
        }

        function updateConnectionStatus(connected = true) {
            const status = document.getElementById('connectionStatus');
            if (connected && connections.size > 0) {
                status.className = 'connection-status status-connected';
                status.innerHTML = `<span class="status-dot"></span><span>${connections.size} Ù‡Ù…Ú©Ø§Ø± Ù…ØªØµÙ„</span>`;
            } else {
                status.className = 'connection-status status-connecting';
                status.innerHTML = '<span class="status-dot"></span><span>Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± Ø§ØªØµØ§Ù„...</span>';
            }
        }

        function enableChat() {
            document.getElementById('messageInput').disabled = false;
            document.getElementById('sendBtn').disabled = false;
            document.getElementById('chatContainer').style.display = 'flex';
            document.getElementById('setupContainer').style.display = 'none';
        }

        function showConnectDialog() {
            document.getElementById('connectDialog').style.display = 'flex';
        }

        function hideConnectDialog() {
            document.getElementById('connectDialog').style.display = 'none';
        }

        function connectFromDialog() {
            const id = document.getElementById('dialogPeerId').value.trim();
            if (id) {
                document.getElementById('peerIdInput').value = id;
                connectToPeer();
                hideConnectDialog();
            }
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // Ø´Ø±ÙˆØ¹ Ø®ÙˆØ¯Ú©Ø§Ø± Ø§Ú¯Ø± Ù‚Ø¨Ù„Ø§Ù‹ Ù†Ø§Ù… ÙˆØ§Ø±Ø¯ Ø´Ø¯Ù‡
        window.addEventListener('load', () => {
            const savedName = localStorage.getItem('chatUsername');
            if (savedName) {
                document.getElementById('usernameInput').value = savedName;
            }
        });

        // Ø°Ø®ÛŒØ±Ù‡ Ù†Ø§Ù…
        document.getElementById('usernameInput').addEventListener('change', (e) => {
            localStorage.setItem('chatUsername', e.target.value);
        });
    </script>
</body>
</html>
