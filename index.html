<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ú†Øª Ø¯Ø§Ø®Ù„ÛŒ P2P - Ø¨Ø¯ÙˆÙ† Ø³Ø±ÙˆØ±</title>
    <style>
        @import url('https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Vazirmatn', sans-serif;
        }

        :root {
            --primary: #2e7d32;
            --secondary: #1565c0;
            --bg: #f0f2f5;
            --danger: #d32f2f;
        }

        body {
            background: var(--bg);
            min-height: 100vh;
        }

        /* ØµÙØ­Ù‡ ÙˆØ±ÙˆØ¯ */
        .setup-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
        }

        .setup-box {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 500px;
            width: 100%;
            text-align: center;
        }

        .setup-box h1 {
            color: var(--primary);
            margin-bottom: 10px;
            font-size: 28px;
        }

        .setup-box p {
            color: #666;
            margin-bottom: 30px;
            line-height: 1.8;
        }

        .room-id-display {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            border: 2px dashed var(--secondary);
        }

        .room-id {
            font-size: 32px;
            font-weight: 900;
            color: var(--secondary);
            letter-spacing: 5px;
            user-select: all;
            cursor: pointer;
        }

        .room-id:hover {
            background: #bbdefb;
            border-radius: 8px;
        }

        .input-group {
            margin: 20px 0;
            text-align: right;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }

        .input-group input {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            text-align: center;
            transition: border-color 0.3s;
        }

        .input-group input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .btn {
            width: 100%;
            padding: 15px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        }

        .btn-secondary {
            background: var(--secondary);
        }

        .divider {
            margin: 30px 0;
            position: relative;
            text-align: center;
        }

        .divider::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background: #ddd;
        }

        .divider span {
            background: white;
            padding: 0 15px;
            position: relative;
            color: #666;
        }

        /* Ú†Øª Ø§ØµÙ„ÛŒ */
        .chat-container {
            display: none;
            height: 100vh;
            flex-direction: column;
        }

        .chat-header {
            background: white;
            padding: 15px 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
        }

        .status-connecting {
            background: #fff3e0;
            color: #e65100;
        }

        .status-connected {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-connecting .status-dot {
            background: #e65100;
        }

        .status-connected .status-dot {
            background: #4caf50;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .peers-list {
            display: flex;
            gap: 10px;
        }

        .peer-badge {
            background: #e3f2fd;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .main-content {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        .sidebar {
            width: 280px;
            background: white;
            border-left: 1px solid #ddd;
            padding: 20px;
            overflow-y: auto;
        }

        .info-card {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .info-card strong {
            color: var(--primary);
        }

        .file-list {
            margin-top: 20px;
        }

        .file-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .file-item:hover {
            background: #e3f2fd;
        }

        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f0f2f5;
        }

        .message {
            max-width: 70%;
            margin-bottom: 20px;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.own {
            margin-left: auto;
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 5px;
            font-size: 12px;
            color: #666;
        }

        .message-content {
            background: white;
            padding: 12px 15px;
            border-radius: 15px;
            border-bottom-right-radius: 5px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            word-wrap: break-word;
            line-height: 1.6;
        }

        .message.own .message-content {
            background: #c8e6c9;
            border-bottom-right-radius: 15px;
            border-bottom-left-radius: 5px;
        }

        .message-file {
            background: white;
            padding: 15px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .file-icon {
            width: 50px;
            height: 50px;
            background: var(--secondary);
            color: white;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .file-info {
            flex: 1;
        }

        .file-name {
            font-weight: bold;
            margin-bottom: 5px;
            word-break: break-all;
        }

        .file-size {
            font-size: 12px;
            color: #666;
        }

        .file-status {
            font-size: 11px;
            color: var(--primary);
            margin-top: 5px;
        }

        .input-area {
            background: white;
            padding: 20px;
            border-top: 1px solid #ddd;
        }

        .typing-indicator {
            font-size: 12px;
            color: #666;
            margin-bottom: 10px;
            height: 20px;
            font-style: italic;
        }

        .input-wrapper {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .message-input {
            flex: 1;
            padding: 12px 20px;
            border: 2px solid #ddd;
            border-radius: 25px;
            font-size: 15px;
            transition: border-color 0.3s;
        }

        .message-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .icon-btn {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: all 0.3s;
        }

        .attach-btn {
            background: #f0f0f0;
            color: #666;
        }

        .attach-btn:hover {
            background: #e0e0e0;
        }

        .send-btn {
            background: var(--primary);
            color: white;
        }

        .send-btn:hover {
            background: #1b5e20;
            transform: scale(1.1);
        }

        .send-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        /* Ù†ÙˆØªÙÛŒÚ©ÛŒØ´Ù† */
        .toast {
            position: fixed;
            top: 20px;
            left: 20px;
            background: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            gap: 10px;
            transform: translateX(-400px);
            transition: transform 0.3s;
            z-index: 3000;
            max-width: 350px;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast-icon {
            font-size: 24px;
        }

        /* Ø±Ø§Ù‡Ù†Ù…Ø§ */
        .help-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .help-modal.active {
            display: flex;
        }

        .help-content {
            background: white;
            padding: 30px;
            border-radius: 20px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .help-content h2 {
            color: var(--primary);
            margin-bottom: 20px;
        }

        .help-content ol {
            line-height: 2;
            padding-right: 20px;
        }

        .help-content li {
            margin-bottom: 10px;
        }

        .close-help {
            float: left;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
        }

        /* Ø±ÛŒØ³Ù¾Ø§Ù†Ø³ÛŒÙˆ */
        @media (max-width: 768px) {
            .sidebar {
                display: none;
            }
        }

        /* Ø§Ø³Ú©Ø±ÙˆÙ„ Ø¨Ø§Ø± */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <!-- ØµÙØ­Ù‡ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ -->
    <div class="setup-container" id="setupContainer">
        <div class="setup-box">
            <h1>ğŸ’¬ Ú†Øª P2P Ø¨Ø¯ÙˆÙ† Ø³Ø±ÙˆØ±</h1>
            <p>Ø¨Ø¯ÙˆÙ† Ù†ÛŒØ§Ø² Ø¨Ù‡ Ù†ØµØ¨! ÙÙ‚Ø· Ú©Ø¯ Ø§ØªØ§Ù‚ Ø±Ø§ Ø¨Ù‡ Ù‡Ù…Ú©Ø§Ø±Ø§Ù†ØªØ§Ù† Ø¨Ø¯Ù‡ÛŒØ¯</p>

            <!-- Ø§ÛŒØ¬Ø§Ø¯ Ø§ØªØ§Ù‚ Ø¬Ø¯ÛŒØ¯ -->
            <div id="createRoomSection">
                <button class="btn" onclick="createRoom()">ğŸš€ Ø§ÛŒØ¬Ø§Ø¯ Ø§ØªØ§Ù‚ Ø¬Ø¯ÛŒØ¯</button>
                
                <div class="divider"><span>ÛŒØ§</span></div>
                
                <div class="input-group">
                    <label>ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø§ØªØ§Ù‚ Ù…ÙˆØ¬ÙˆØ¯:</label>
                    <input type="text" id="joinRoomId" placeholder="Ú©Ø¯ Û¶ Ø±Ù‚Ù…ÛŒ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯" maxlength="6">
                </div>
                <button class="btn btn-secondary" onclick="joinRoom()">ğŸ”— Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø§ØªØ§Ù‚</button>
            </div>

            <!-- Ù†Ù…Ø§ÛŒØ´ Ú©Ø¯ Ø§ØªØ§Ù‚ -->
            <div id="roomCreatedSection" class="hidden">
                <div class="room-id-display">
                    <div style="margin-bottom:10px;color:#666;">Ú©Ø¯ Ø§ØªØ§Ù‚ Ø´Ù…Ø§:</div>
                    <div class="room-id" id="roomIdDisplay" onclick="copyRoomId()">------</div>
                    <div style="margin-top:10px;font-size:12px;color:#666;">Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯ ØªØ§ Ú©Ù¾ÛŒ Ø´ÙˆØ¯</div>
                </div>
                
                <div class="input-group">
                    <label>Ù†Ø§Ù… Ø´Ù…Ø§:</label>
                    <input type="text" id="usernameInput" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ø¹Ù„ÛŒ" maxlength="20">
                </div>
                
                <button class="btn" onclick="enterChat()">âœ… ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ú†Øª</button>
                
                <div style="margin-top:20px;padding:15px;background:#fff3e0;border-radius:10px;font-size:14px;">
                    <strong>ğŸ“‹ Ø±Ø§Ù‡Ù†Ù…Ø§:</strong><br>
                    Ø§ÛŒÙ† Ú©Ø¯ Ø±Ø§ Ø¨Ù‡ Ù‡Ù…Ú©Ø§Ø±Ø§Ù†ØªØ§Ù† Ø¨Ø¯Ù‡ÛŒØ¯ ØªØ§ Ø¨Ù‡ Ø§ØªØ§Ù‚ ÙˆØµÙ„ Ø´ÙˆÙ†Ø¯.
                </div>
            </div>
        </div>
    </div>

    <!-- ØµÙØ­Ù‡ Ú†Øª -->
    <div class="chat-container" id="chatContainer">
        <div class="chat-header">
            <div>
                <h2 style="color: var(--primary);">ğŸ’¬ Ø§ØªØ§Ù‚: <span id="displayRoomId">----</span></h2>
            </div>
            <div style="display:flex;gap:15px;align-items:center;">
                <div class="peers-list" id="peersList"></div>
                <div class="connection-status status-connecting" id="connectionStatus">
                    <span class="status-dot"></span>
                    <span>Ø¯Ø± Ø­Ø§Ù„ Ø§ØªØµØ§Ù„...</span>
                </div>
                <button onclick="showHelp()" style="background:none;border:none;font-size:20px;cursor:pointer;">â“</button>
            </div>
        </div>

        <div class="main-content">
            <div class="sidebar">
                <div class="info-card">
                    <strong>ğŸ†” Ø´Ù†Ø§Ø³Ù‡ Ø´Ù…Ø§:</strong><br>
                    <span id="myId" style="font-family:monospace;font-size:12px;"></span>
                </div>
                
                <div class="info-card">
                    <strong>ğŸ‘¥ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ù…ØªØµÙ„:</strong>
                    <div id="usersList" style="margin-top:10px;"></div>
                </div>

                <div class="file-list" id="fileList">
                    <strong>ğŸ“ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØªÛŒ:</strong>
                    <div style="margin-top:10px;font-size:12px;color:#666;">Ù‡Ù†ÙˆØ² ÙØ§ÛŒÙ„ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ù†Ø´Ø¯Ù‡</div>
                </div>
            </div>

            <div class="chat-area">
                <div class="messages-container" id="messagesContainer">
                    <div style="text-align:center;padding:40px;color:#999;">
                        <div style="font-size:48px;margin-bottom:20px;">ğŸ‘‹</div>
                        <h3>Ø¨Ù‡ Ú†Øª Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯!</h3>
                        <p>Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯ Ùˆ Enter Ø¨Ø²Ù†ÛŒØ¯</p>
                    </div>
                </div>
                
                <div class="input-area">
                    <div class="typing-indicator" id="typingIndicator"></div>
                    <div class="input-wrapper">
                        <button class="icon-btn attach-btn" onclick="document.getElementById('fileInput').click()" title="Ø§Ø±Ø³Ø§Ù„ ÙØ§ÛŒÙ„">
                            ğŸ“
                        </button>
                        <input type="file" id="fileInput" style="display:none" onchange="sendFile(this.files[0])">
                        <input type="text" class="message-input" id="messageInput" 
                               placeholder="Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯..." 
                               onkeypress="handleKeyPress(event)"
                               oninput="handleTyping()"
                               disabled>
                        <button class="icon-btn send-btn" id="sendBtn" onclick="sendMessage()" disabled>
                            â¤
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ø±Ø§Ù‡Ù†Ù…Ø§ -->
    <div class="help-modal" id="helpModal" onclick="hideHelp(event)">
        <div class="help-content" onclick="event.stopPropagation()">
            <button class="close-help" onclick="hideHelp()">Ã—</button>
            <h2>ğŸ“– Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡</h2>
            <ol>
                <li><strong>Ø§ÛŒØ¬Ø§Ø¯ Ø§ØªØ§Ù‚:</strong> Ø±ÙˆÛŒ "Ø§ÛŒØ¬Ø§Ø¯ Ø§ØªØ§Ù‚ Ø¬Ø¯ÛŒØ¯" Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯</li>
                <li><strong>Ú©Ø¯ Ø§ØªØ§Ù‚:</strong> Ú©Ø¯ Û¶ Ø±Ù‚Ù…ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯Ù‡ Ø±Ø§ Ú©Ù¾ÛŒ Ú©Ù†ÛŒØ¯</li>
                <li><strong>Ø§Ø´ØªØ±Ø§Ú©â€ŒÚ¯Ø°Ø§Ø±ÛŒ:</strong> Ø§ÛŒÙ† Ú©Ø¯ Ø±Ø§ Ø¨Ù‡ Ù‡Ù…Ú©Ø§Ø±Ø§Ù†ØªØ§Ù† Ø¨Ø¯Ù‡ÛŒØ¯</li>
                <li><strong>Ø§ØªØµØ§Ù„:</strong> Ù‡Ù…Ú©Ø§Ø±Ø§Ù† Ø¨Ø§ ÙˆØ§Ø±Ø¯ Ú©Ø±Ø¯Ù† Ú©Ø¯ Ø¨Ù‡ Ø§ØªØ§Ù‚ ÙˆØµÙ„ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯</li>
                <li><strong>Ú†Øª:</strong> Ø­Ø§Ù„Ø§ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ù¾ÛŒØ§Ù… Ùˆ ÙØ§ÛŒÙ„ Ø±Ø¯ Ùˆ Ø¨Ø¯Ù„ Ú©Ù†ÛŒØ¯!</li>
            </ol>
            <div style="margin-top:20px;padding:15px;background:#e3f2fd;border-radius:10px;">
                <strong>ğŸ’¡ Ù†Ú©ØªÙ‡:</strong> Ø§ÛŒÙ† Ú†Øª Ú©Ø§Ù…Ù„Ø§Ù‹ P2P Ø§Ø³Øª Ùˆ Ù‡ÛŒÚ† Ø³Ø±ÙˆØ±ÛŒ Ø¯Ø± Ù…ÛŒØ§Ù† Ù†ÛŒØ³Øª. 
                Ø§Ú¯Ø± Ù‡Ù…Ù‡ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† ØµÙØ­Ù‡ Ø±Ø§ Ø¨Ø¨Ù†Ø¯Ù†Ø¯ØŒ Ø§ØªØ§Ù‚ Ù¾Ø§Ú© Ù…ÛŒâ€ŒØ´ÙˆØ¯.
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast">
        <span class="toast-icon" id="toastIcon">ğŸ“¢</span>
        <div>
            <div id="toastTitle" style="font-weight:bold;"></div>
            <div id="toastMessage" style="font-size:14px;color:#666;"></div>
        </div>
    </div>

    <script>
        // ==================== WebRTC Chat Application ====================
        
        let roomId;
        let username;
        let myId = generateId();
        let connections = new Map(); // peerId -> {connection, dataChannel, username}
        let messageHistory = [];
        let receivedFiles = new Map();
        let typingTimer;
        let isTyping = false;

        // ØªÙˆÙ„ÛŒØ¯ ID ØªØµØ§Ø¯ÙÛŒ
        function generateId() {
            return Math.random().toString(36).substr(2, 9);
        }

        // ØªÙˆÙ„ÛŒØ¯ Ú©Ø¯ Ø§ØªØ§Ù‚
        function generateRoomId() {
            return Math.floor(100000 + Math.random() * 900000).toString();
        }

        // ==================== UI Functions ====================

        function createRoom() {
            roomId = generateRoomId();
            document.getElementById('roomIdDisplay').textContent = roomId;
            document.getElementById('createRoomSection').classList.add('hidden');
            document.getElementById('roomCreatedSection').classList.remove('hidden');
        }

        function joinRoom() {
            const input = document.getElementById('joinRoomId');
            roomId = input.value.trim();
            
            if (roomId.length !== 6 || !/^\d+$/.test(roomId)) {
                showToast('âŒ Ø®Ø·Ø§', 'Ú©Ø¯ Ø§ØªØ§Ù‚ Ø¨Ø§ÛŒØ¯ Û¶ Ø±Ù‚Ù… Ø¨Ø§Ø´Ø¯');
                return;
            }
            
            document.getElementById('roomIdDisplay').textContent = roomId;
            document.getElementById('createRoomSection').classList.add('hidden');
            document.getElementById('roomCreatedSection').classList.remove('hidden');
        }

        function copyRoomId() {
            const code = document.getElementById('roomIdDisplay').textContent;
            navigator.clipboard.writeText(code).then(() => {
                showToast('âœ… Ú©Ù¾ÛŒ Ø´Ø¯', 'Ú©Ø¯ Ø§ØªØ§Ù‚ Ø¯Ø± Ú©Ù„ÛŒÙ¾â€ŒØ¨ÙˆØ±Ø¯ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯');
            });
        }

        function enterChat() {
            const input = document.getElementById('usernameInput');
            username = input.value.trim() || 'Ú©Ø§Ø±Ø¨Ø± Ù†Ø§Ø´Ù†Ø§Ø³';
            
            document.getElementById('setupContainer').style.display = 'none';
            document.getElementById('chatContainer').style.display = 'flex';
            document.getElementById('displayRoomId').textContent = roomId;
            document.getElementById('myId').textContent = myId;
            
            initializeWebRTC();
        }

        // ==================== WebRTC Core ====================

        function initializeWebRTC() {
            // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² PeerJS ÛŒØ§ Ø³ÛŒÚ¯Ù†Ø§Ù„ÛŒÙ†Ú¯ Ø¯Ø³ØªÛŒ
            // Ø§ÛŒÙ†Ø¬Ø§ Ø§Ø² Ø±ÙˆØ´ Ø¯Ø³ØªÛŒ Ø¨Ø§ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² copy-paste SDP Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
            
            showToast('â„¹ï¸ Ø±Ø§Ù‡Ù†Ù…Ø§', 'Ø¨Ø±Ø§ÛŒ Ø§ØªØµØ§Ù„ØŒ Ú©Ø¯ SDP Ø±Ø§ Ø¨Ø§ Ù‡Ù…Ú©Ø§Ø±Ø§Ù† Ø®ÙˆØ¯ Ø¨Ù‡ Ø§Ø´ØªØ±Ø§Ú© Ø¨Ú¯Ø°Ø§Ø±ÛŒØ¯');
            
            // Ø§ÛŒØ¬Ø§Ø¯ Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† host ÛŒØ§ joiner
            setupConnection();
        }

        function setupConnection() {
            // Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ø§ÛŒØ¯ Ø§Ø² ÛŒÚ© signaling server Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒÙ…
            // ÙˆÙ„ÛŒ Ú†ÙˆÙ† Ù†Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒÙ… Ø³Ø±ÙˆØ± Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´ÛŒÙ…ØŒ Ø§Ø² Ø±ÙˆØ´ manual signaling Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
            
            const config = {
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:stun1.l.google.com:19302' }
                ]
            };

            // Ù†Ù…Ø§ÛŒØ´ Ø¯Ú©Ù…Ù‡ Ø¨Ø±Ø§ÛŒ Ú©Ù¾ÛŒ/Ù¾ÛŒØ³Øª SDP
            showSDPPanel();
        }

        function showSDPPanel() {
            // Ø§ÛŒØ¬Ø§Ø¯ Ù¾Ù†Ù„ Ø¨Ø±Ø§ÛŒ ØªØ¨Ø§Ø¯Ù„ Ø¯Ø³ØªÛŒ SDP
            const panel = document.createElement('div');
            panel.id = 'sdpPanel';
            panel.innerHTML = `
                <div style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:white;padding:30px;border-radius:20px;box-shadow:0 20px60px rgba(0,0,0,0.3);z-index:2500;max-width:500px;width:90%;">
                    <h3 style="margin-bottom:20px;color:var(--primary);">ğŸ”— Ø§ØªØµØ§Ù„ Ø¯Ø³ØªÛŒ (Ø¨Ø¯ÙˆÙ† Ø³Ø±ÙˆØ±)</h3>
                    <div style="margin-bottom:20px;">
                        <label style="display:block;margin-bottom:5px;font-weight:bold;">Ú©Ø¯ Ø§ØªØµØ§Ù„ Ø´Ù…Ø§ (Ú©Ù¾ÛŒ Ú©Ù†ÛŒØ¯):</label>
                        <textarea id="localSDP" readonly style="width:100%;height:100px;padding:10px;border:2px solid #ddd;border-radius:8px;font-family:monospace;font-size:12px;direction:ltr;"></textarea>
                        <button onclick="createOffer()" style="margin-top:10px;padding:8px 15px;background:var(--primary);color:white;border:none;border-radius:5px;cursor:pointer;">ğŸ”„ ØªÙˆÙ„ÛŒØ¯ Ú©Ø¯</button>
                    </div>
                    <div style="margin-bottom:20px;">
                        <label style="display:block;margin-bottom:5px;font-weight:bold;">Ú©Ø¯ Ù‡Ù…Ú©Ø§Ø± Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ù¾ÛŒØ³Øª Ú©Ù†ÛŒØ¯:</label>
                        <textarea id="remoteSDP" style="width:100%;height:100px;padding:10px;border:2px solid #ddd;border-radius:8px;font-family:monospace;font-size:12px;direction:ltr;"></textarea>
                        <button onclick="acceptAnswer()" style="margin-top:10px;padding:8px 15px;background:var(--secondary);color:white;border:none;border-radius:5px;cursor:pointer;">âœ… Ø§ØªØµØ§Ù„</button>
                    </div>
                    <button onclick="closeSDPPanel()" style="width:100%;padding:10px;background:#f44336;color:white;border:none;border-radius:8px;cursor:pointer;">âŒ Ø¨Ø³ØªÙ†</button>
                </div>
                <div style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:2400;" onclick="closeSDPPanel()"></div>
            `;
            document.body.appendChild(panel);
        }

        let localConnection;
        let sendChannel;

        async function createOffer() {
            localConnection = new RTCPeerConnection({
                iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
            });

            sendChannel = localConnection.createDataChannel('chat', {
                ordered: true
            });
            
            setupDataChannel(sendChannel, 'host');

            localConnection.onicecandidate = event => {
                if (!event.candidate) {
                    document.getElementById('localSDP').value = btoa(JSON.stringify(localConnection.localDescription));
                }
            };

            const offer = await localConnection.createOffer();
            await localConnection.setLocalDescription(offer);
        }

        async function acceptAnswer() {
            const sdp = JSON.parse(atob(document.getElementById('remoteSDP').value));
            await localConnection.setRemoteDescription(new RTCSessionDescription(sdp));
            closeSDPPanel();
            onConnected();
        }

        // Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±ÛŒ Ú©Ù‡ join Ù…ÛŒâ€ŒÚ©Ù†Ø¯
        async function joinAsGuest() {
            const remoteDesc = JSON.parse(atob(document.getElementById('remoteSDP').value));
            
            localConnection = new RTCPeerConnection({
                iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
            });

            localConnection.ondatachannel = event => {
                sendChannel = event.channel;
                setupDataChannel(sendChannel, 'guest');
            };

            await localConnection.setRemoteDescription(new RTCSessionDescription(remoteDesc));
            
            const answer = await localConnection.createAnswer();
            await localConnection.setLocalDescription(answer);

            localConnection.onicecandidate = event => {
                if (!event.candidate) {
                    document.getElementById('localSDP').value = btoa(JSON.stringify(localConnection.localDescription));
                    showToast('âœ… Ø¢Ù…Ø§Ø¯Ù‡', 'Ú©Ø¯ Ù¾Ø§Ø³Ø® Ø´Ù…Ø§ ØªÙˆÙ„ÛŒØ¯ Ø´Ø¯. Ø¢Ù† Ø±Ø§ Ú©Ù¾ÛŒ Ú©Ù†ÛŒØ¯.');
                }
            };
        }

        function setupDataChannel(channel, role) {
            channel.onopen = () => {
                console.log('Data channel opened!');
                onConnected();
                broadcastUserInfo();
            };

            channel.onmessage = event => {
                handleMessage(JSON.parse(event.data));
            };

            channel.onclose = () => {
                showToast('âš ï¸ Ù‚Ø·Ø¹ Ø´Ø¯', 'Ø§ØªØµØ§Ù„ Ø¨Ø§ Ù‡Ù…Ú©Ø§Ø± Ù‚Ø·Ø¹ Ø´Ø¯');
                updateConnectionStatus(false);
            };
        }

        function onConnected() {
            updateConnectionStatus(true);
            document.getElementById('messageInput').disabled = false;
            document.getElementById('sendBtn').disabled = false;
            showToast('âœ… Ù…ØªØµÙ„ Ø´Ø¯', 'Ø§Ú©Ù†ÙˆÙ† Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ú†Øª Ú©Ù†ÛŒØ¯!');
        }

        function updateConnectionStatus(connected) {
            const status = document.getElementById('connectionStatus');
            if (connected) {
                status.className = 'connection-status status-connected';
                status.innerHTML = '<span class="status-dot"></span><span>Ù…ØªØµÙ„</span>';
            } else {
                status.className = 'connection-status status-connecting';
                status.innerHTML = '<span class="status-dot"></span><span>Ù‚Ø·Ø¹ Ø´Ø¯Ù‡</span>';
            }
        }

        // ==================== Messaging ====================

        function handleMessage(data) {
            switch(data.type) {
                case 'chat':
                    displayMessage(data);
                    break;
                case 'typing':
                    showTyping(data.username, data.isTyping);
                    break;
                case 'file-offer':
                    handleFileOffer(data);
                    break;
                case 'file-chunk':
                    handleFileChunk(data);
                    break;
                case 'user-info':
                    addPeer(data);
                    break;
            }
        }

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            if (!text || !sendChannel || sendChannel.readyState !== 'open') return;

            const message = {
                type: 'chat',
                id: Date.now(),
                username: username,
                text: text,
                timestamp: new Date().toISOString(),
                isOwn: true
            };

            sendChannel.send(JSON.stringify(message));
            displayMessage({...message, isOwn: true});
            input.value = '';
            stopTyping();
        }

        function displayMessage(data) {
            const container = document.getElementById('messagesContainer');
            
            // Ø­Ø°Ù Ù¾ÛŒØ§Ù… Ø®ÙˆØ´â€ŒØ¢Ù…Ø¯Ú¯ÙˆÛŒÛŒ Ø§Ú¯Ø± ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯
            if (container.children.length === 1 && container.children[0].querySelector('h3')) {
                container.innerHTML = '';
            }

            const div = document.createElement('div');
            div.className = `message ${data.isOwn ? 'own' : ''}`;
            
            const time = new Date(data.timestamp).toLocaleTimeString('fa-IR', {
                hour: '2-digit',
                minute: '2-digit'
            });

            div.innerHTML = `
                <div class="message-header">
                    <span>${data.isOwn ? 'Ø´Ù…Ø§' : data.username}</span>
                    <span style="color:#999;">${time}</span>
                </div>
                <div class="message-content">${escapeHtml(data.text)}</div>
            `;

            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        // ==================== File Transfer ====================

        async function sendFile(file) {
            if (!file || !sendChannel || sendChannel.readyState !== 'open') {
                showToast('âŒ Ø®Ø·Ø§', 'Ø§ØªØµØ§Ù„ Ø¨Ø±Ù‚Ø±Ø§Ø± Ù†ÛŒØ³Øª');
                return;
            }

            const chunkSize = 16384; // 16KB
            const fileId = generateId();
            
            // Ø§Ø±Ø³Ø§Ù„ Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙØ§ÛŒÙ„
            sendChannel.send(JSON.stringify({
                type: 'file-offer',
                fileId: fileId,
                fileName: file.name,
                fileSize: file.size,
                fileType: file.type,
                username: username
            }));

            // Ø®ÙˆØ§Ù†Ø¯Ù† Ùˆ Ø§Ø±Ø³Ø§Ù„ ÙØ§ÛŒÙ„
            const buffer = await file.arrayBuffer();
            const totalChunks = Math.ceil(buffer.byteLength / chunkSize);
            
            showToast('ğŸ“¤ Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„', `ÙØ§ÛŒÙ„ ${file.name} Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„...`);

            for (let i = 0; i < totalChunks; i++) {
                const chunk = buffer.slice(i * chunkSize, (i + 1) * chunkSize);
                const base64 = arrayBufferToBase64(chunk);
                
                sendChannel.send(JSON.stringify({
                    type: 'file-chunk',
                    fileId: fileId,
                    chunk: base64,
                    index: i,
                    total: totalChunks
                }));

                // Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ´Ø±ÙØª
                if (i % 10 === 0) {
                    const progress = Math.round((i / totalChunks) * 100);
                    updateFileProgress(fileId, progress);
                }
            }

            showToast('âœ… Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯', 'ÙØ§ÛŒÙ„ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯');
        }

        function handleFileOffer(data) {
            receivedFiles.set(data.fileId, {
                chunks: [],
                fileName: data.fileName,
                fileSize: data.fileSize,
                received: 0
            });
            
            showToast('ğŸ“¥ Ø¯Ø±ÛŒØ§ÙØª ÙØ§ÛŒÙ„', `ÙØ§ÛŒÙ„ ${data.fileName} Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª...`);
        }

        function handleFileChunk(data) {
            const file = receivedFiles.get(data.fileId);
            if (!file) return;

            file.chunks[data.index] = base64ToArrayBuffer(data.chunk);
            file.received++;

            if (file.received === data.total) {
                // ØªÚ©Ù…ÛŒÙ„ ÙØ§ÛŒÙ„
                const blob = new Blob(file.chunks);
                const url = URL.createObjectURL(blob);
                
                addFileToList(file.fileName, file.fileSize, url);
                showToast('âœ… Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯', `ÙØ§ÛŒÙ„ ${file.fileName} Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯`);
            }
        }

        function addFileToList(name, size, url) {
            const list = document.getElementById('fileList');
            const sizeStr = formatFileSize(size);
            
            const item = document.createElement('div');
            item.className = 'file-item';
            item.innerHTML = `
                <div class="file-icon">ğŸ“„</div>
                <div class="file-info">
                    <div class="file-name">${name}</div>
                    <div class="file-size">${sizeStr}</div>
                </div>
            `;
            item.onclick = () => {
                const a = document.createElement('a');
                a.href = url;
                a.download = name;
                a.click();
            };

            // Ø­Ø°Ù Ù¾ÛŒØ§Ù… "Ù‡Ù†ÙˆØ² ÙØ§ÛŒÙ„ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ù†Ø´Ø¯Ù‡"
            if (list.children[1] && list.children[1].tagName === 'DIV') {
                list.children[1].remove();
            }

            list.appendChild(item);
        }

        // ==================== Utilities ====================

        function arrayBufferToBase64(buffer) {
            const bytes = new Uint8Array(buffer);
            let binary = '';
            for (let i = 0; i < bytes.byteLength; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            return btoa(binary);
        }

        function base64ToArrayBuffer(base64) {
            const binary = atob(base64);
            const bytes = new Uint8Array(binary.length);
            for (let i = 0; i < binary.length; i++) {
                bytes[i] = binary.charCodeAt(i);
            }
            return bytes.buffer;
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function handleKeyPress(e) {
            if (e.key === 'Enter') sendMessage();
        }

        function handleTyping() {
            if (!sendChannel || sendChannel.readyState !== 'open') return;
            
            if (!isTyping) {
                sendChannel.send(JSON.stringify({
                    type: 'typing',
                    username: username,
                    isTyping: true
                }));
                isTyping = true;
            }

            clearTimeout(typingTimer);
            typingTimer = setTimeout(stopTyping, 1000);
        }

        function stopTyping() {
            if (!isTyping) return;
            sendChannel.send(JSON.stringify({
                type: 'typing',
                username: username,
                isTyping: false
            }));
            isTyping = false;
        }

        function showTyping(username, isTyping) {
            const indicator = document.getElementById('typingIndicator');
            indicator.textContent = isTyping ? `âœï¸ ${username} Ø¯Ø± Ø­Ø§Ù„ Ù†ÙˆØ´ØªÙ†...` : '';
        }

        function showToast(title, message) {
            const toast = document.getElementById('toast');
            document.getElementById('toastIcon').textContent = title.includes('âŒ') ? 'âŒ' : 
                                                               title.includes('âœ…') ? 'âœ…' : 
                                                               title.includes('ğŸ“¤') ? 'ğŸ“¤' : 
                                                               title.includes('ğŸ“¥') ? 'ğŸ“¥' : 'â„¹ï¸';
            document.getElementById('toastTitle').textContent = title;
            document.getElementById('toastMessage').textContent = message;
            
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 4000);
        }

        function showHelp() {
            document.getElementById('helpModal').classList.add('active');
        }

        function hideHelp(e) {
            if (!e || e.target.id === 'helpModal') {
                document.getElementById('helpModal').classList.remove('active');
            }
        }

        function closeSDPPanel() {
            const panel = document.getElementById('sdpPanel');
            if (panel) panel.remove();
        }

        function broadcastUserInfo() {
            if (sendChannel && sendChannel.readyState === 'open') {
                sendChannel.send(JSON.stringify({
                    type: 'user-info',
                    id: myId,
                    username: username
                }));
            }
        }

        function addPeer(data) {
            const list = document.getElementById('usersList');
            const peersList = document.getElementById('peersList');
            
            if (!document.getElementById(`peer-${data.id}`)) {
                const div = document.createElement('div');
                div.id = `peer-${data.id}`;
                div.innerHTML = `<div style="padding:5px;background:#e3f2fd;border-radius:5px;margin-bottom:5px;">${data.username}</div>`;
                list.appendChild(div);

                const badge = document.createElement('div');
                badge.className = 'peer-badge';
                badge.textContent = data.username;
                peersList.appendChild(badge);
            }
        }

        // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¯Ú©Ù…Ù‡ Ø¨Ø±Ø§ÛŒ joiner
        window.addEventListener('load', () => {
            // Ø¨Ø±Ø±Ø³ÛŒ Ù¾Ø§Ø±Ø§Ù…ØªØ± URL
            const params = new URLSearchParams(window.location.search);
            if (params.get('join')) {
                document.querySelector('.divider').insertAdjacentHTML('afterend', `
                    <button onclick="joinAsGuestMode()" style="width:100%;padding:10px;background:#ff9800;color:white;border:none;border-radius:8px;cursor:pointer;margin-top:10px;">
                        ğŸ”— Ø­Ø§Ù„Øª Ù…Ù‡Ù…Ø§Ù† (Ø¯Ø±ÛŒØ§ÙØª Ú©Ø¯ Ø§ÙˆÙ„ÛŒÙ‡)
                    </button>
                `);
            }
        });

        function joinAsGuestMode() {
            document.getElementById('createRoomSection').classList.add('hidden');
            document.getElementById('roomCreatedSection').classList.remove('hidden');
            document.querySelector('#roomCreatedSection .btn').onclick = startAsGuest;
        }

        async function startAsGuest() {
            username = document.getElementById('usernameInput').value.trim() || 'Ù…Ù‡Ù…Ø§Ù†';
            document.getElementById('setupContainer').style.display = 'none';
            document.getElementById('chatContainer').style.display = 'flex';
            document.getElementById('displayRoomId').textContent = 'Ù…Ù‡Ù…Ø§Ù†';
            
            showSDPPanel();
            // ØªØºÛŒÛŒØ± ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ Ø­Ø§Ù„Øª guest
            document.querySelector('button[onclick="createOffer()"]').onclick = joinAsGuest;
        }
    </script>
</body>
</html>
